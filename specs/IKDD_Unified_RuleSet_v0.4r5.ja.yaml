IKDD_RuleSet:
  id: IKDD_UNIFIED_RULESET
  version: 0.4r5
  description: >
    Intent OS（WHAT探索 / Intent固定）と
    IKDD Universal Rule（HOW導出）を統合したルールセット。
    Meta-Anchorにより Intent の揺らぎを停止し、WHAT→HOWを一意導出する。

  # ==========================================================
  # 1. Intent OS (WHAT discovery / Intent-first)
  # ==========================================================
  IntentOS:
    input: "AmbiguousRequest（曖昧な要求 / 自然言語）"
    output: "Intent（WHAT / WHY / DONE / Constraints / Invariant）"

    rules:
      - "WHAT が確定するまで HOW に進まない"
      - "Intent は WHAT / WHY / DONE を必ず持つ"
      - "不足は TBD に閉じる（創作・推測を禁止）"
      - "Intent の変化は Intent diff として記録する"
      - "TBD が 1つ以上ある Intent は draft とみなし、HOW / Implementation の生成を禁止する"

    output_schema:
      id: <string>
      version: <semver>
      layer: Client | Kernel | Runtime | Meta-Kernel

      Intent:
        what: <string>
        why:  <string>
        done: <string>       # 検証可能な条件（自然文不可）

      Context:
        inputs?:  [string]
        outputs?: [string]

      Constraints:
        must?:      [string]
        must_not?:  [string]
        keep?:      [string]
        error_if?:  [string]

      Invariant?: [string]

      Scope:
        includes?: [string]
        excludes?: [string]

      TBD?: [string]         # ← 消えるまで HOW に進めない

  # ==========================================================
  # 2. Meta-Anchor (Intent Fixed-Point / Stop iteration)
  # ==========================================================
  MetaAnchor:
    layer: Meta-Kernel
    purpose: >
      Meta-Intent による WHAT探索が終わる条件を保証し、
      Intent を唯一の固定点（Fixed-Point）に昇格させる。

    enforced: true

    stop_if:
      - what_is_single_point        # WHAT が一点に収束した
      - why_explained               # WHY が説明できる
      - done_is_testable            # DONE が検証可能（自然文禁止）
      - invariant_defined           # Invariant が存在する
      - tbd_is_zero                 # TBD = []

    on_stop:
      - "Intent を fixed に昇格（draft → fixed）"
      - "Phase を IKDD Universal へ移行可能にする"

    on_fail:
      - "不足を TBD に追加し、IntentOS（WHAT探索）へ戻す"
      - "Meta-Intent を続行"

    output:
      state: fixed | draft
      next: IntentOS | IKDD_Universal

  # ==========================================================
  # 3. IKDD Universal Rules (HOW derivation / Knowledge usage)
  # ==========================================================
  IKDD_Universal:
    required_blocks:
      - Intent
      - HOW
      - Knowledge
      - Done

    HOW:
      structure:
        must:      "必ず守る条件"
        forbidden: "禁止事項"
        keep:      "変更不可領域"
        error:     "失敗時の復元動作"

      rules:
        - "HOW は手順ではなく制約である"
        - "HOW × Knowledge で Implementation を導出する"
        - "推論・創作は禁止、導出のみ"
        - "Intent が fixed（TBD = 0）であることが開始条件"
        - "TBD != [] の場合、HOW に進んではならない"

    Knowledge:
      rules:
        - "Knowledge に書かれた事実(API/仕様/ルール)のみ使用する"
        - "HOW を Knowledge に混ぜてはいけない（手段禁止）"
        - "外部情報は Knowledge に存在するときのみ許可"

    Done:
      rules:
        - "PostCondition として実装検収に使用する"
        - "Done を満たさない実装は不正（Rejected）"

  # ==========================================================
  # 4. Phase Switch Rule (State machine)
  # ==========================================================
  phase_switch:
    enforced: true
    rule: |
      IntentOS フェーズでは WHAT のみ扱う。
      Meta-Anchor によって Intent が fixed か判定される。
      Intent が fixed（TBD = 0）になった場合のみ、
      IKDD Universal フェーズへ移行できる。

  # ==========================================================
  # 5. Global Rules (No hallucination)
  # ==========================================================
  global_rules:
    - "Unknown は UNKNOWN として書く"
    - "外部情報は Knowledge に存在するときのみ使用"
    - "Intent が DONE 判定を持たない限り Implementation を生成しない"
    - "Intent が fixed（TBD = 0）でない限り Implementation を生成しない"

  # ==========================================================
  # 6. License (for Rule Set / Schema / Specification)
  # ==========================================================
  License:
    type: CC-BY-4.0
    url: https://creativecommons.org/licenses/by/4.0/
    notice: >
      You are free to share and adapt this Rule Set, including commercial use,
      as long as credit is given to the original author:
      "IKDD Unified Rule Set — © 2025 Shoichi Kanbara (pikovolt)"
